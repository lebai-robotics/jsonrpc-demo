# Context
Filename: 场景图片上传功能实现任务.md
Created On: 2024-12-27T21:30:00Z
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
为Flutter机械臂控制应用添加场景图片上传功能。用户点击配置页面场景管理中的"上传图片"按钮，可以选择本地图片文件并保存到应用内部目录。上传的图片需要显示在首页的场景卡片中。

具体要求：
1. 使用image_picker组件选择图片
2. 将图片保存到本地应用内部目录assets文件夹下
3. 图片路径存储到场景配置中的imagePath字段
4. 首页SceneCard组件能正确渲染图片

# Project Overview
这是一个Flutter机械臂控制应用，主要功能包括：
- 机器人配置管理
- 场景管理和执行
- JSON-RPC通信
- 本地配置存储

项目已有完整的场景管理功能，现在需要添加图片上传能力。

---
*以下部分由AI在协议执行过程中维护*
---

# Analysis (由RESEARCH模式填充)
通过代码分析发现：

1. **现有架构**：
   - SceneButton模型已有imagePath字段支持
   - SceneCard组件已有图片渲染逻辑（使用AssetImage）
   - RobotProvider已有updateScene方法支持更新图片路径
   - pubspec.yaml中已包含file_picker依赖

2. **关键文件**：
   - `lib/models/scene_button.dart`: 场景模型，包含imagePath字段
   - `lib/widgets/scene_card.dart`: 场景卡片组件，第50-64行有图片渲染逻辑
   - `lib/providers/robot_provider.dart`: updateScene方法第141-174行
   - `lib/screens/config_screen.dart`: 第426行有_uploadImage调用但方法未定义

3. **技术约束**：
   - 应用使用shared_preferences存储配置
   - 需要image_picker替代file_picker用于图片选择
   - 需要path_provider获取应用文档目录
   - SceneCard使用AssetImage加载图片，需要改为File或NetworkImage

4. **缺失组件**：
   - 缺少_uploadImage方法实现
   - 缺少image_picker依赖
   - 缺少assets目录和图片文件管理逻辑
   - SceneCard的图片加载需要支持文件路径

# Proposed Solution (由INNOVATE模式填充)
经过分析，提出以下解决方案：

**方案一：使用应用文档目录存储**
- 使用path_provider获取应用文档目录
- 在文档目录下创建scene_images子目录
- 使用File.copy()复制选中的图片
- 使用FileImage而非AssetImage加载图片

**方案二：使用应用支持目录存储**  
- 使用getApplicationSupportDirectory()
- 更适合应用内部使用的文件存储

**最终选择方案一**，因为：
- 文档目录更稳定，应用卸载重装时数据可以保留
- 便于用户访问和管理（如果需要）
- path_provider已经集成

**技术实现要点**：
1. 添加image_picker依赖到pubspec.yaml
2. 实现_uploadImage方法：选择图片→复制到应用目录→更新场景配置
3. 修改SceneCard使用FileImage加载本地文件
4. 添加文件管理功能：删除旧图片避免存储空间浪费

# Implementation Plan (由PLAN模式生成)

## 实施检查清单
1. ✅ 更新pubspec.yaml添加image_picker依赖
2. ✅ 在ConfigService中添加图片文件管理方法  
3. ✅ 在ConfigScreen中实现_uploadImage方法
4. ✅ 修改SceneCard组件支持本地文件图片显示
5. 🔄 测试图片上传和显示功能

## 当前执行步骤
> 当前执行: "测试图片上传和显示功能"

## 任务进度 (由EXECUTE模式追加完成步骤后)
* [2024-12-27T21:45:00Z]
  * 步骤: 1. 更新pubspec.yaml添加image_picker依赖
  * 修改: 在pubspec.yaml中添加image_picker: ^1.0.4和path: ^1.8.0依赖
  * 变更摘要: 添加图片选择和路径处理依赖
  * 原因: 执行计划步骤1
  * 阻塞: 无
  * 用户确认状态: 待确认

* [2024-12-27T21:46:00Z]
  * 步骤: 2. 在ConfigService中添加图片文件管理方法
  * 修改: 在lib/services/config_service.dart中添加getSceneImagesDirectory、saveSceneImage、deleteSceneImage、cleanupUnusedImages方法
  * 变更摘要: 实现完整的场景图片文件管理功能
  * 原因: 执行计划步骤2
  * 阻塞: 无
  * 用户确认状态: 待确认

* [2024-12-27T21:47:00Z]
  * 步骤: 3. 在ConfigScreen中实现_uploadImage方法
  * 修改: 在lib/screens/config_screen.dart中实现完整的_uploadImage方法，支持相册和拍照两种图片来源
  * 变更摘要: 实现图片选择、压缩、保存和更新场景配置的完整流程
  * 原因: 执行计划步骤3
  * 阻塞: 无
  * 用户确认状态: 待确认

* [2024-12-27T21:48:00Z]
  * 步骤: 4. 修改SceneCard组件支持本地文件图片显示
  * 修改: 在lib/widgets/scene_card.dart中添加_buildSceneImage方法，支持FileImage和AssetImage两种加载方式
  * 变更摘要: 场景卡片组件能正确显示本地文件图片
  * 原因: 执行计划步骤4
  * 阻塞: 无
  * 用户确认状态: 待确认
